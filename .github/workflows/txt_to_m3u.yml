#!/bin/bash

# 設定變數
REPO_URL="https://github.com/WaykeYu/MyTV_tw.git"
TW_URL="https://raw.githubusercontent.com/WaykeYu/MyTV_tw/refs/heads/main/TW_allsource"
UBTV_URL="https://raw.githubusercontent.com/WaykeYu/MyTV_tw/refs/heads/main/UBTV"
TW_FILENAME="TW_allsource.txt"
UBTV_FILENAME="UBTV.txt"
M3U_FILENAME="TW_allsource.m3u"
LOCAL_REPO="MyTV_tw"

# 下載 TW_allsource 檔案
echo "正在下載 TW_allsource..."
curl -o "$TW_FILENAME" "$TW_URL"
if [ ! -s "$TW_FILENAME" ]; then
    echo "下載 TW_allsource 失敗，請檢查 URL 是否有效。"
    exit 1
fi
echo "下載 TW_allsource 完成！"

# 下載 UBTV 檔案
echo "正在下載 UBTV..."
curl -o "$UBTV_FILENAME" "$UBTV_URL"
if [ ! -s "$UBTV_FILENAME" ]; then
    echo "下載 UBTV 失敗，請檢查 URL 是否有效。"
    exit 1
fi
echo "下載 UBTV 完成！"

# 合併 TW_allsource 和 UBTV 檔案
echo "正在合併檔案..."
cat "$TW_FILENAME" "$UBTV_FILENAME" > "merged.txt"
echo "檔案合併完成！"

# 轉換為 M3U 格式
echo "正在轉換為 M3U 格式..."
echo "#EXTM3U" > "$M3U_FILENAME"
while IFS=, read -r name url; do
    if [[ -n "$name" && -n "$url" ]]; then
        echo "#EXTINF:-1,$name" >> "$M3U_FILENAME"
        echo "$url" >> "$M3U_FILENAME"
    fi
done < "merged.txt"

echo "轉換完成！已儲存為 $M3U_FILENAME"

# 檢查是否安裝 Git
if ! command -v git &> /dev/null; then
    echo "Git 未安裝，請先安裝 Git。"
    exit 1
fi

# 克隆 GitHub 倉庫（如果尚未克隆）
if [ ! -d "$LOCAL_REPO" ]; then
    echo "正在克隆 GitHub 倉庫..."
    git clone "$REPO_URL"
fi

cd "$LOCAL_REPO" || exit 1

# 移動 M3U 檔案到倉庫資料夾
mv "../$M3U_FILENAME" .

# 提交並推送至 GitHub
echo "提交並推送變更到 GitHub..."
git add "$M3U_FILENAME"
git commit -m "新增合併版的 TW_allsource.m3u"
git push origin main

echo "操作完成，已推送至 GitHub！"
